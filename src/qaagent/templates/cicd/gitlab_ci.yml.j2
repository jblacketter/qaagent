# Generated by qaagent - QA Automation Pipeline
# Framework: {{ framework }}
# Project: {{ project_name }}

variables:
  PYTHON_VERSION: "{{ python_version }}"
  BASE_URL: ${BASE_URL}
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

stages:
  - setup
  - analyze
  - generate
  - test
  - report

cache:
  paths:
    - .cache/pip

# Bootstrap qaagent profile for CI
setup:
  stage: setup
  image: python:${PYTHON_VERSION}
  script:
    - pip install qaagent
{% if framework in ("fastapi", "flask", "django") %}
    - pip install -r requirements.txt
{% endif %}
    - qaagent config init . --template {{ framework }} --name {{ project_name }}
    - qaagent use {{ project_name }}
  artifacts:
    paths:
      - .qaagent.yaml

discover-routes:
  stage: analyze
  image: python:${PYTHON_VERSION}
  script:
    - pip install qaagent
    - qaagent analyze routes --format json --out routes.json
  artifacts:
    paths:
      - routes.json

assess-risks:
  stage: analyze
  image: python:${PYTHON_VERSION}
  needs:
    - discover-routes
  script:
    - pip install qaagent
    - qaagent analyze strategy --routes routes.json --out strategy.yaml
  artifacts:
    paths:
      - strategy.yaml
{% if suites.unit %}

generate-unit-tests:
  stage: generate
  image: python:${PYTHON_VERSION}
  needs:
    - discover-routes
  script:
    - pip install qaagent
    - qaagent generate unit-tests --out generated/unit
  artifacts:
    paths:
      - generated/unit

run-unit-tests:
  stage: test
  image: python:${PYTHON_VERSION}
  needs:
    - generate-unit-tests
  script:
    - pip install qaagent pytest
    - python -m pytest generated/unit -q --junitxml=reports/unit.xml
  artifacts:
    when: always
    paths:
      - reports/unit.xml
    reports:
      junit: reports/unit.xml
  allow_failure: true
{% endif %}
{% if suites.behave %}

generate-behave-tests:
  stage: generate
  image: python:${PYTHON_VERSION}
  needs:
    - discover-routes
  script:
    - pip install qaagent
    - qaagent generate behave --out generated/behave
  artifacts:
    paths:
      - generated/behave

run-behave-tests:
  stage: test
  image: python:${PYTHON_VERSION}
  needs:
    - generate-behave-tests
  script:
    - pip install qaagent behave
    - python -m behave generated/behave --junit --junit-directory reports/
  artifacts:
    when: always
    paths:
      - reports/
    reports:
      junit: reports/TESTS-*.xml
  allow_failure: true
{% endif %}
{% if suites.e2e %}

generate-e2e-tests:
  stage: generate
  image: python:${PYTHON_VERSION}
  needs:
    - discover-routes
  script:
    - pip install qaagent
    - qaagent generate e2e --out generated/e2e
  artifacts:
    paths:
      - generated/e2e

run-e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.48.0-focal
  needs:
    - generate-e2e-tests
  script:
    - cd generated/e2e
    - npm install
    - npx playwright test --reporter=junit
  artifacts:
    when: always
    paths:
      - generated/e2e/test-results/
    reports:
      junit: generated/e2e/test-results/results.xml
  allow_failure: true
{% endif %}

qa-report:
  stage: report
  image: python:${PYTHON_VERSION}
  when: always
  script:
    - pip install qaagent
    - qaagent report generate --format html --out reports/qa-report.html
  artifacts:
    paths:
      - reports/qa-report.html
    expire_in: 30 days
  allow_failure: true
