"""
Auto-generated unit tests for {{ resource_name }} API
Generated by QA Agent with enhanced assertions and test data
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
import httpx
from typing import Dict, Any


class Test{{ resource_name|title }}API:
    """Unit tests for /{{ resource_name }} endpoints"""

    {% for case in test_cases %}
    {% if case.type == "happy_path" %}
    def {{ case.name }}(self, api_client{% if case.route.method in ["POST", "PUT", "PATCH"] %}, sample_{{ resource_name }}_data{% endif %}):
        """{{ case.description }}"""
        {% if case.route.method in ["POST", "PUT", "PATCH"] %}
        # Arrange - use realistic test data
        test_data = sample_{{ resource_name }}_data

        # Act
        response = api_client.{{ case.route.method.lower() }}("{{ case.sample_path }}", json=test_data)

        # Assert - Enhanced assertions
        assert response.status_code == {{ case.expected_status }}, f"Expected {{ case.expected_status }}, got {response.status_code}: {response.text}"

        {% if case.route.method in ["POST", "PUT"] %}
        # Verify response structure
        data = response.json()
        assert data is not None, "Response should not be None"
        assert isinstance(data, dict), "Response should be a dictionary"

        # Verify expected fields
        {% if case.route.method == "POST" %}
        assert "id" in data, "Created resource should have an ID"
        {% endif %}

        # Verify data matches input (where applicable)
        for key in test_data:
            if key in data:
                assert data[key] == test_data[key], f"Field '{key}' should match input"
        {% endif %}
        {% elif case.route.method == "GET" %}
        # Act
        response = api_client.{{ case.route.method.lower() }}("{{ case.sample_path }}")

        # Assert
        assert response.status_code == {{ case.expected_status }}, f"Expected {{ case.expected_status }}, got {response.status_code}"

        # Verify response structure
        data = response.json()
        assert data is not None, "Response should not be None"

        {% if '{' not in case.route.path %}
        # List endpoint - should return array
        assert isinstance(data, list) or isinstance(data, dict), "Response should be a list or dict"
        {% else %}
        # Single resource endpoint - should return object
        assert isinstance(data, dict), "Response should be a dictionary"
        assert "id" in data, "Resource should have an ID"
        {% endif %}
        {% elif case.route.method == "DELETE" %}
        # Act
        response = api_client.{{ case.route.method.lower() }}("{{ case.sample_path }}")

        # Assert
        assert response.status_code in [{{ case.expected_status }}, 200], "Delete should return 204 or 200"
        {% endif %}

    {% elif case.type == "invalid_data" %}
    def {{ case.name }}(self, api_client):
        """{{ case.description }}"""
        # Arrange - empty/invalid data
        invalid_data = {}  # Empty data should fail validation

        # Act
        response = api_client.{{ case.route.method.lower() }}("{{ case.route.path }}", json=invalid_data)

        # Assert - Should reject invalid data
        assert response.status_code in [400, 422], f"Should reject invalid data with 400/422, got {response.status_code}"

        # Verify error response structure
        if response.status_code == 422:
            data = response.json()
            assert "error" in data or "detail" in data or "message" in data, "Error response should have error details"

    {% elif case.type == "parametrized" %}
    @pytest.mark.parametrize("invalid_param", {{ case.parameters }})
    def {{ case.name }}(self, api_client, invalid_param{% if case.route.method in ["POST", "PUT", "PATCH"] %}, sample_{{ resource_name }}_data{% endif %}):
        """{{ case.description }}"""
        # Arrange
        {% if case.route.method in ["POST", "PUT", "PATCH"] %}
        test_data = sample_{{ resource_name }}_data
        {% endif %}

        # Act - use invalid path parameter
        {% if case.route.method in ["POST", "PUT", "PATCH"] %}
        response = api_client.{{ case.route.method.lower() }}(f"{{ case.route.path.split('{')[0] }}{invalid_param}", json=test_data)
        {% else %}
        response = api_client.{{ case.route.method.lower() }}(f"{{ case.route.path.split('{')[0] }}{invalid_param}")
        {% endif %}

        # Assert - Should fail with client error
        assert response.status_code in [400, 404, 422], f"Invalid parameter should cause client error, got {response.status_code}"

    {% endif %}
    {% endfor %}

    {% if test_cases|selectattr("route.auth_required")|list %}
    def test_{{ resource_name }}_requires_auth(self, api_client_no_auth):
        """Test that authenticated endpoints reject requests without auth"""
        # This test verifies auth is enforced
        # Act - call endpoint without authentication
        response = api_client_no_auth.get("{{ test_cases[0].route.path }}")

        # Assert - should be unauthorized
        assert response.status_code == 401, "Endpoint should require authentication"
    {% endif %}
